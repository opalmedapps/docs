# Hospital Integration

An institution or hospital can integrate their data sources with the opal solution through a series of REST API endpoints provided by the Opal Application layer. In addition, hospitals must provide some endpoints to Opal in order to facilitate patient demographic lookups, historical data fetching, etc.

Opal source data APIs are provided by four subcomponents within the application layer. Those are:

* [Opal-Backend](https://gitlab.com/opalmedapps/backend)
* [Opal-Admin](https://gitlab.com/opalmedapps/opalAdmin)
* [Opal-Labs](https://gitlab.com/opalmedapps/opal-labs)
* [Opal-RMS](https://gitlab.com/opalmedapps/ORMS)  *If wait room support is enabled at hospital*

In order to successfully integrate the opal solution with a hospital data system, the above mentioned application docker images must be
deployed to an application server and configured with database access, SSL certificates, and environment configuration.

*TODO: Link to external documentation on deployment/ansible scripts, Greg task.*

## Authentication

Depending on which opal application is providing the endpoint, the authentication method will be slightly different.

### Opal-Backend

The Opal-Backend is built on Django and uses [DjangoRestFramework](https://www.django-rest-framework.org/) which provides support for token-based request signing. During the setup of the opal application layer, an administrator can issue the hospital data system an API token which should be appended to the headers section of all API requests to the Opal-Backend, for example:

```bash
curl --location 'https://{server-opal}/api/' \
--header 'Content-Type: application/json' \
--header 'Authorization: Token 111aaa111bbb222ccc333ddd444ddde555fff6666'
```

### Opal-Admin

Opal-Admin refers to the legacy php system originally built to provide backend support to the Opal Administrative web applications. It exposes an authorization endpoint for system users, based on a basic username/password combination for that system user. Opal-Admin will respond to successful calls at this endpoint with an array of values corresponding to the specific system user and their preferences and permissions. Also included in the response will be a session/cookie string that should be appended to the headers of future request(s) to regular non-authentication endpoints. For example:

```bash
curl --location 'https://{server-opal}/opalAdmin/user/system-login' \
--header 'Content-Type: application/x-www-form-urlencoded'
```

Handle the response and append the cookie string to the next request:

```bash
curl --location 'https://{server-opal}/opalAdmin/patient/get/patient-exist' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--header 'Cookie: sessionId=zxcvbnm1234567890qwertyuiop' \
--data 'mrn=1111111&site=RVH'
```

### Opal-Labs

Opal-labs is a small application that handles the fetching, processing, and storage of patient lab test results. This application uses the traefik reverse proxy's [BasicAuth middleware](https://doc.traefik.io/traefik/middlewares/http/basicauth/) for authenticating incoming requests. During setup of the opal application server, a new basic auth hashed username/password pair should be generated by following the steps below. The resulting pair can be Base64 encoded and appended to the request headers with the Authorization tag.

#### Basic Authentication with Traefik

Use the htpasswd utility to create a bcrypt hash, pressing enter when given the opportunity to enter an additional password for the password. For example:

```bash
echo $(htpasswd -nB hospital_integration_engine) | sed -e s/\\$/\\$\\$/g
```

The username and password used in the Basic Authentication header request from the hospital integration engine needs to be base64 encoded. So:

```bash
echo -n 'hospital_integration_engine:$$2y$$05$$lQUmd4J/8ygoe4d4EOm6WeisBNdYFCMvBgeCkDnc2q9loUrMeEkQ.' | base64
```

The base64 representation of the username:password can then be added as an Authorization header in the destination connector settings for our labs channel, prepended by the string 'Basic' to indicate the auth type.

```bash
--header 'Authorization Basic NldlaXNCTmRZRkNNdkJnZUNrRG5jMnE5bG9Vck1lRWtRLg=='
```

### Opal-RMS

Opal-RMS separates private from public APIs and thus any calls to the public API endpoints are authenticated by default.

## Data Format

TODO

## OpenAPI Schemas for Opal Source Data

In each of the opal applications there is an `openapi.yml` file providing full details of all source data endpoints that a hospital can use to send data into the Opal Application Layer. In addition, the Opal-Backend provides a swagger rendering of its openapi definition (which is generated dynamically using [drf-spectacular](https://pypi.org/project/drf-spectacular/)). The swagger page is accessible for authenticated users via `/api/schema/swagger-ui`.

* Opal-Backend openapi.yml
* Opal-Admin openapi.yml
* Opal-Labs openapi.myl
* Opal-RMS openapi.yml

## Requirements for Hospital Endpoints
